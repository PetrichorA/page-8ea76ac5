EPUBJS.Hooks.register("beforeChapterDisplay").endnotes=function(e,t){var o=t.contents.querySelectorAll("a[href]"),n=Array.prototype.slice.call(o),r=(EPUBJS.core.folder(location.pathname),EPUBJS.cssPath,{});EPUBJS.core.addCss(EPUBJS.cssPath+"popup.css",!1,t.render.document.head),n.forEach((function(e){function o(){r[s].classList.add("on")}function n(){r[s].classList.remove("on")}function a(){setTimeout((function(){r[s].classList.remove("show")}),100)}var i,s,l,c,d,p;"noteref"==e.getAttribute("epub:type")&&(i=e.getAttribute("href"),s=i.replace("#",""),l=t.render.document.getElementById(s),e.addEventListener("mouseover",(function(){var i,h,u=t.height,m=t.width,g=225;p||(i=l.cloneNode(!0),p=i.querySelector("p")),r[s]||(r[s]=document.createElement("div"),r[s].setAttribute("class","popup"),pop_content=document.createElement("div"),r[s].appendChild(pop_content),pop_content.appendChild(p),pop_content.setAttribute("class","pop_content"),t.render.document.body.appendChild(r[s]),r[s].addEventListener("mouseover",o,!1),r[s].addEventListener("mouseout",n,!1),t.on("renderer:pageChanged",a,this),t.on("renderer:pageChanged",n,this)),i=r[s],h=e.getBoundingClientRect(),c=h.left,d=h.top,i.classList.add("show"),popRect=i.getBoundingClientRect(),i.style.left=c-popRect.width/2+"px",i.style.top=d+"px",g>u/2.5&&(g=u/2.5,pop_content.style.maxHeight=g+"px"),popRect.height+d>=u-25?(i.style.top=d-popRect.height+"px",i.classList.add("above")):i.classList.remove("above"),c-popRect.width<=0?(i.style.left=c+"px",i.classList.add("left")):i.classList.remove("left"),c+popRect.width/2>=m?(i.style.left=c-300+"px",popRect=i.getBoundingClientRect(),i.style.left=c-popRect.width+"px",popRect.height+d>=u-25?(i.style.top=d-popRect.height+"px",i.classList.add("above")):i.classList.remove("above"),i.classList.add("right")):i.classList.remove("right")}),!1),e.addEventListener("mouseout",a,!1))})),e&&e()},EPUBJS.Hooks.register("beforeChapterDisplay").mathml=function(e,t){if(-1!==t.currentChapter.manifestProperties.indexOf("mathml")){t.render.iframe.contentWindow.mathmlCallback=e;var o=document.createElement("script");o.type="text/x-mathjax-config",o.innerHTML='        MathJax.Hub.Register.StartupHook("End",function () {           window.mathmlCallback();         });        MathJax.Hub.Config({jax: ["input/TeX","input/MathML","output/SVG"],extensions: ["tex2jax.js","mml2jax.js","MathEvents.js"],TeX: {extensions: ["noErrors.js","noUndefined.js","autoload-all.js"]},MathMenu: {showRenderer: false},menuSettings: {zoom: "Click"},messageStyle: "none"});                 ',t.doc.body.appendChild(o),EPUBJS.core.addScript("http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML",null,t.doc.head)}else e&&e()},EPUBJS.Hooks.register("beforeChapterDisplay").smartimages=function(e,t){var o=t.contents.querySelectorAll("img"),n=Array.prototype.slice.call(o),r=t.height;"reflowable"==t.layoutSettings.layout?(n.forEach((function(e){var o=function(){var o,n=e.getBoundingClientRect(),a=n.height,i=n.top,s=e.getAttribute("data-height")||a,l=Number(getComputedStyle(e,"").fontSize.match(/(\d*(\.\d*)?)px/)[1]),c=l?l/2:0;r=t.contents.clientHeight,i<0&&(i=0),e.style.maxWidth="100%",s+i>=r?(i<r/2?(o=r-i-c,e.style.maxHeight=o+"px",e.style.width="auto"):(s>r&&(e.style.maxHeight=r+"px",e.style.width="auto",s=(n=e.getBoundingClientRect()).height),e.style.display="block",e.style.WebkitColumnBreakBefore="always",e.style.breakBefore="column"),e.setAttribute("data-height",o)):(e.style.removeProperty("max-height"),e.style.removeProperty("margin-top"))};e.addEventListener("load",o,!1),t.on("renderer:resized",o),t.on("renderer:chapterUnload",(function(){t.off("renderer:resized",o),t.off("renderer:chapterUnload",this)})),o()})),e&&e()):e()},EPUBJS.Hooks.register("beforeChapterDisplay").transculsions=function(e,t){var o=t.contents.querySelectorAll("[transclusion]");Array.prototype.slice.call(o).forEach((function(e){function o(){d=s,(c=i)>chapter.colWidth&&(n=chapter.colWidth/c,c=chapter.colWidth,d*=n),a.width=c,a.height=d}var n,r=e.getAttribute("ref"),a=document.createElement("iframe"),i=e.getAttribute("width"),s=e.getAttribute("height"),l=e.parentNode,c=i,d=s;o(),t.listenUntil("renderer:resized","renderer:chapterUnloaded",o),a.src=r,l.replaceChild(a,e)})),e&&e()};